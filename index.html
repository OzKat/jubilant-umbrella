<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odyssey plays GameBoyAdvance games</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            background-color: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .retro-font {
            font-family: 'Press Start 2P', cursive;
        }

         .gb-button {
            transition: transform 0.05s, box-shadow 0.05s;
            user-select: none;
            touch-action: manipulation;
        }

        .gb-button:active {
            transform: translateY(2px);
            box-shadow: none !important;
        }

        .d-pad-btn {
            background: #2a2a2a;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            border-radius: 6px;
            box-shadow: 0 5px 0 #000;
        }

        .shoulder-btn {
            background: #3d3d3d;
            height: 40px;
            width: 100px;
            border-radius: 12px 12px 4px 4px;
            box-shadow: 0 4px 0 #111;
            font-size: 14px;
            font-weight: bold;
            color: #aaa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 0 #7a0000;
        }

        .log-container {
            height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        #trainer-name-input {
            background: transparent;
            border-bottom: 2px solid #333;
            transition: border-color 0.3s;
        }
        #trainer-name-input:focus {
            border-color: #dc2626;
            outline: none;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4 md:p-8 text-white">

    <!-- Top Status Bar -->
    <div class="w-full max-w-2xl flex flex-wrap gap-4 justify-between items-center mb-8 bg-gray-900 p-4 rounded-2xl border border-gray-800 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-full bg-red-600 animate-pulse" id="status-light"></div>
            <span class="retro-font text-[10px]" id="status-text">CONNECTING...</span>
        </div>
        
        <!-- Editable Name Field -->
        <div class="flex items-center gap-2 bg-black/50 px-4 py-2 rounded-xl border border-gray-700">
            <span class="text-[9px] text-gray-500 font-bold uppercase tracking-tighter">Trainer:</span>
            <input type="text" id="trainer-name-input" maxlength="20" value="ODC" 
                   class="retro-font text-[10px] text-yellow-400 w-28 text-center uppercase">
        </div>
    </div>

    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
        
        <!-- Controller Section -->
        <div class="flex flex-col items-center">
            <div class="bg-gray-800 p-8 rounded-[3rem] border-8 border-gray-700 shadow-2xl relative w-full max-w-md">
                
                <!-- Shoulder Buttons -->
                <div class="flex justify-between mb-12">
                    <button onpointerdown="sendInput('l')" class="gb-button shoulder-btn">L</button>
                    <button onpointerdown="sendInput('r')" class="gb-button shoulder-btn">R</button>
                </div>

                <div class="flex flex-col items-center gap-12">
                    <!-- Directional Pad -->
                    <div class="relative w-44 h-44">
                        <button onpointerdown="sendInput('up')" class="gb-button d-pad-btn absolute top-0 left-1/2 -translate-x-1/2">▲</button>
                        <button onpointerdown="sendInput('left')" class="gb-button d-pad-btn absolute left-0 top-1/2 -translate-y-1/2">◀</button>
                        <button onpointerdown="sendInput('right')" class="gb-button d-pad-btn absolute right-0 top-1/2 -translate-y-1/2">▶</button>
                        <button onpointerdown="sendInput('down')" class="gb-button d-pad-btn absolute bottom-0 left-1/2 -translate-x-1/2">▼</button>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-8">
                        <div class="text-center">
                            <button onpointerdown="sendInput('b')" class="gb-button action-btn bg-red-700 text-xl shadow-[0_5px_0_#5a0000]">B</button>
                            <span class="text-[10px] text-gray-500 mt-3 block font-bold uppercase tracking-widest">B</span>
                        </div>
                        <div class="text-center">
                            <button onpointerdown="sendInput('a')" class="gb-button action-btn bg-red-700 text-xl shadow-[0_5px_0_#5a0000]">A</button>
                            <span class="text-[10px] text-gray-500 mt-3 block font-bold uppercase tracking-widest">A</span>
                        </div>
                    </div>
                </div>

                <!-- Select & Start -->
                <div class="flex justify-center gap-10 mt-12">
                    <div class="text-center">
                        <button onpointerdown="sendInput('select')" class="gb-button w-14 h-4 bg-gray-600 rounded-full shadow-lg border-b-4 border-gray-900"></button>
                        <span class="text-[9px] text-gray-500 block mt-3 font-bold tracking-widest uppercase">Select</span>
                    </div>
                    <div class="text-center">
                        <button onpointerdown="sendInput('start')" class="gb-button w-14 h-4 bg-gray-600 rounded-full shadow-lg border-b-4 border-gray-900"></button>
                        <span class="text-[9px] text-gray-500 block mt-3 font-bold tracking-widest uppercase">Start</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feed Section -->
        <div class="w-full flex flex-col gap-4">
            <div class="bg-black rounded-2xl p-6 border border-gray-800 shadow-inner">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-900">
                    <div class="text-[10px] text-green-500 font-bold tracking-[0.2em] uppercase">Global Input Feed</div>
                    <div class="text-[9px] text-gray-600 uppercase" id="connection-count">0 Players</div>
                </div>
                <div id="log" class="log-container text-xs font-mono text-green-400"></div>
            </div>
        </div>
    </div>

    <script>
        const NGROK_URL = 'https://nia-locomotor-lissomly.ngrok-free.dev';
        
        const socket = io(NGROK_URL, {
            extraHeaders: { "ngrok-skip-browser-warning": "any-value" }
        });
        
        const statusLight = document.getElementById('status-light');
        const statusText = document.getElementById('status-text');
        const logEl = document.getElementById('log');
        const nameInput = document.getElementById('trainer-name-input');

        const savedName = localStorage.getItem('pkmn-trainer-name');
        if (savedName) nameInput.value = savedName;

        socket.on('connect', () => {
            statusLight.classList.replace('bg-red-600', 'bg-green-500');
            statusText.innerText = 'ONLINE';
            addLog("SYSTEM", "Handshake accepted.");
        });

        socket.on('disconnect', () => {
            statusLight.classList.replace('bg-green-500', 'bg-red-600');
            statusText.innerText = 'OFFLINE';
        });

        function sendInput(key) {
            const currentName = nameInput.value.trim() || "Anonymous";
            localStorage.setItem('pkmn-trainer-name', currentName);
            
            socket.emit('input', { key: key, name: currentName });
            addLog("YOU", key.toUpperCase());
        }

        socket.on('broadcastInput', (data) => {
            addLog(data.user, data.key.toUpperCase());
        });

        function addLog(user, message) {
            const entry = document.createElement('div');
            entry.className = "py-2 border-b border-gray-900 flex justify-between items-center animate-in fade-in slide-in-from-top-1";
            entry.innerHTML = `
                <span class="opacity-60 truncate max-w-[120px] uppercase font-bold">${user}</span> 
                <span class="bg-gray-900 px-3 py-1 rounded text-white font-bold border border-gray-800 min-w-[60px] text-center">${message}</span>
            `;
            logEl.prepend(entry);
            if (logEl.children.length > 50) logEl.lastChild.remove();
        }

        const keyMap = {
            'ArrowUp': 'up', 'ArrowDown': 'down', 'ArrowLeft': 'left', 'ArrowRight': 'right',
            'z': 'a', 'x': 'b', 'q': 'l', 'e': 'r', 'Enter': 'start', 'Shift': 'select'
        };

        window.addEventListener('keydown', (e) => {
            if (document.activeElement === nameInput) return;
            const cmd = keyMap[e.key];
            if (cmd) {
                e.preventDefault();
                sendInput(cmd);
            }
        });
    </script>
</body>
</html>
